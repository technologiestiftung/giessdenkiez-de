import { expect, test } from "vitest";
import { useTreeAgeClassification } from "../../components/tree-detail/hooks/use-tree-age-classification";
import { useTreeWaterNeedsData } from "../../components/tree-detail/hooks/use-tree-water-needs-data";
import {
	TreeAgeClassification,
	TreeCoreData,
	TreeWateringData,
} from "../../components/tree-detail/tree-types";

test("should calculate correct water needs for junior tree", () => {
	const waterings: TreeWateringData[] = [
		{
			id: 1,
			timestamp: new Date().toISOString(),
			amount: 10,
			username: "test-user",
			tree_id: "_22002d8af7",
		},
		{
			id: 2,
			timestamp: new Date().toISOString(),
			amount: 20,
			username: "test-user",
			tree_id: "_22002d8af7",
		},
		{
			id: 3,
			timestamp: new Date().toISOString(),
			amount: 30,
			username: "test-user",
			tree_id: "_22002d8af7",
		},
		{
			id: 4,
			timestamp: new Date().toISOString(),
			amount: 40,
			username: "test-user",
			tree_id: "_22002d8af7",
		},
	];

	const treeData: TreeCoreData = {
		id: "_22002a6665",
		lat: "13.51075",
		lng: "52.51674",
		artdtsch: "Seiden-Kiefer, Strobe, Weymouths-Kiefer",
		artbot: "Pinus strobus",
		gattungdeutsch: "KIEFER",
		gattung: "PINUS",
		pflanzjahr: 2010,
		standalter: "13",
		baumhoehe: "17",
		bezirk: "Lichtenberg",
		eigentuemer: "Land Berlin",
		radolan_sum: 191,
		radolan_days: [
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 4, 3, 1, 2, 7, 7, 1, 4, 2, 6,
			5, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 3, 1, 4, 0, 0, 0, 0, 0, 1, 0, 0, 2, 7, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 2, 17, 8, 1, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 3, 0, 0, 0, 0, 0, 6, 5,
			11, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 7, 2, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
			4, 7, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 13, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 5, 10,
		],
		caretaker: null,
	};

	const { treeAgeClassification, treeAge } = useTreeAgeClassification(
		treeData,
		new Date("2024-01-01T00:00+00:00"),
	);
	expect(treeAge).toBe(14);
	expect(treeAgeClassification).toBe(TreeAgeClassification.JUNIOR);

	const {
		rainSum,
		rainPercentage,
		wateringSum,
		wateringPercentage,
		referenceWaterAmount,
		shouldBeWatered,
		waterParts,
		stillMissingWater,
	} = useTreeWaterNeedsData(treeData, waterings, treeAgeClassification);

	expect(rainSum).toBe(2);
	expect(wateringSum).toBe(100);
	expect(referenceWaterAmount).toBe(200);
	expect(rainPercentage).toBe(0.01);
	expect(wateringPercentage).toBe(0.5);
	expect(shouldBeWatered).toBe(true);
	expect(stillMissingWater).toBe(98);
	expect(waterParts.map((p) => p.progress)).toEqual([0.01, 0.5]);
});
